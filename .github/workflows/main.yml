name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - feat--test-cambios-workflow
    paths:
      - "API/**"
      - "client/**"
      - ".github/workflows/main.yml"
  pull_request:
    branches:
      - main
      - feat--test-cambios-workflow
    paths:
      - "API/**"
      - "client/**"
      - ".github/workflows/main.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.x.x"

      - name: Restore dependencies (Backend)
        working-directory: ./API
        run: dotnet restore ../sistema-gestion-inventario.sln

      - name: Build backend
        working-directory: ./API
        run: dotnet build ../sistema-gestion-inventario.sln --configuration Release --no-restore

      - name: Test backend with coverage
        working-directory: ./API.Tests
        run: dotnet test --collect:"XPlat Code Coverage" --settings ./coverlet.runsettings

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate backend coverage report
        run: |
          COBERTURA_INPUT=$(find ./API.Tests/TestResults -type f -name 'coverage.cobertura.xml' | head -n 1)
          if [ -z "$COBERTURA_INPUT" ]; then echo "Cobertura file not found"; exit 1; fi
          # Generate filtered reports (HTML + Cobertura) to exclude noise like EF Migrations and Program.cs
          reportgenerator \
            -reports:"$COBERTURA_INPUT" \
            -targetdir:"./API.Tests/coveragereport" \
            -reporttypes:"HtmlInline_AzurePipelines;Cobertura" \
            -assemblyfilters:"+API" \
            -classfilters:"-API.Migrations.*;-*.Program" \
            -filefilters:"-*/Migrations/*;-*Program.cs"
          # Use the filtered Cobertura output for threshold enforcement
          echo "COBERTURA_FILE=./API.Tests/coveragereport/Cobertura.xml" >> $GITHUB_ENV

      - name: Enforce backend coverage threshold (>=70% lines)
        run: |
          FILE="$COBERTURA_FILE"
          RATE=$(grep -oP 'line-rate="\K[0-9.]+' "$FILE")
          PCT=$(awk -v r="$RATE" 'BEGIN{printf "%.0f", r*100}')
          echo "Backend line coverage: ${PCT}%"
          if [ "$PCT" -lt 70 ]; then echo "Coverage below 70%"; exit 1; fi

      - name: Upload Backend Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: |
            ./API.Tests/coveragereport
            ./API.Tests/TestResults/**/coverage.cobertura.xml

      - name: Publish backend
        working-directory: ./API
        run: dotnet publish ../sistema-gestion-inventario.sln --configuration Release --output ${{ github.workspace }}/publish_backend --no-build

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: ${{ github.workspace }}/publish_backend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: ./client/package-lock.json

      - name: Install dependencies (Frontend)
        working-directory: ./client
        run: npm ci

      - name: Test frontend with coverage
        working-directory: ./client
        env:
          CI: "true"
        run: npm run test -- --coverage --runInBand

      - name: Enforce frontend coverage threshold (>=60% lines)
        working-directory: ./client
        run: |
          node -e "const s=require('./coverage/coverage-summary.json'); const pct=s.total.lines.pct; console.log('Frontend line coverage:', pct+'%'); if (pct < 60) { console.error('Coverage below 60%'); process.exit(1); }"

      - name: Upload Frontend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: ./client/coverage

      - name: Build frontend
        working-directory: ./client
        run: npm run build -- --configuration production

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./client/dist/client/browser

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feat--test-cambios-workflow')) || (github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'feat--test-cambios-workflow'))
    env:
      SSH_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      WEB_USER: ${{ vars.WEB_USER }}
      WEB_GROUP: ${{ vars.WEB_GROUP }}

    steps:
      - name: "Preflight: check SSH connectivity to deployment host"
        id: preflight_ssh
        shell: bash
        run: |
          set -euo pipefail
          HOST="${SSH_HOST}"
          PORT="${SSH_PORT:-22}"
          if [ -z "$HOST" ]; then
            echo "SSH host not configured (secrets.SERVER_HOST). Skipping deploy."
            echo "reachable=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Checking TCP connectivity to $HOST:$PORT ..."
          if timeout 5 bash -lc "</dev/tcp/$HOST/$PORT" 2>/dev/null; then
            echo "reachable=true" >> "$GITHUB_OUTPUT"
            echo "SSH port is reachable. Proceeding with deploy steps."
          else
            echo "reachable=false" >> "$GITHUB_OUTPUT"
            echo "Host unreachable or SSH not listening (connection refused/timeout). Skipping deploy steps."
          fi
      - name: Download Backend Artifact
        if: steps.preflight_ssh.outputs.reachable == 'true'
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./publish_backend_temp

      - name: Download Frontend Artifact
        if: steps.preflight_ssh.outputs.reachable == 'true'
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./dist_frontend_temp

      - name: "Debug: Show contents of downloaded Backend Artifact on Runner"
        if: steps.preflight_ssh.outputs.reachable == 'true'
        run: |
          echo "Content of publish_backend_temp on GitHub Actions runner:"
          ls -la ./publish_backend_temp
          ls -la ./publish_backend_temp/.

      - name: "Debug: Show contents of downloaded Frontend Artifact on Runner"
        if: steps.preflight_ssh.outputs.reachable == 'true'
        run: |
          echo "Content of dist_frontend_temp on GitHub Actions runner:"
          ls -la ./dist_frontend_temp
          ls -la ./dist_frontend_temp/.

      - name: Transfer Backend Files to Server (with custom port)
        if: steps.preflight_ssh.outputs.reachable == 'true' && env.SSH_PORT != ''
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "./publish_backend_temp/"
          target: "/tmp/backend_deploy_temp_dir"

      - name: Transfer Backend Files to Server (default port 22)
        if: steps.preflight_ssh.outputs.reachable == 'true' && (env.SSH_PORT == '' || env.SSH_PORT == null)
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          source: "./publish_backend_temp/"
          target: "/tmp/backend_deploy_temp_dir"

      - name: Deploy Backend on Server (custom port)
        if: steps.preflight_ssh.outputs.reachable == 'true' && env.SSH_PORT != ''
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          envs: WEB_USER,WEB_GROUP
          script: |
            echo "Iniciando despliegue de Backend en el servidor..."
            set -eo pipefail

            # Detect default web user/group if not provided (Arch: http, Debian/Ubuntu: www-data)
            WEB_USER="${WEB_USER:-$(getent passwd http >/dev/null 2>&1 && echo http || echo www-data)}"
            WEB_GROUP="${WEB_GROUP:-$WEB_USER}"

            # Detener servicio (sudo necesario)
            sudo systemctl stop kioscomanager.service || true

            # Crear directorio temporal si no existe
            mkdir -p /tmp/backend_deploy_temp_dir

            # Limpiar el directorio de publicación (ci-cd-deploy tiene permisos)
            sudo rm -rf /var/www/kiosco-manager/publish/*

            # Copiar los archivos desde el directorio temporal
            sudo cp -r /tmp/backend_deploy_temp_dir/publish_backend_temp/. /var/www/kiosco-manager/publish/

            # Limpiar el directorio temporal
            rm -rf /tmp/backend_deploy_temp_dir

            # Ajustar propietario del despliegue
            sudo chown -R "$WEB_USER":"$WEB_GROUP" /var/www/kiosco-manager/publish
      - name: Deploy Backend on Server (default port 22)
        if: steps.preflight_ssh.outputs.reachable == 'true' && (env.SSH_PORT == '' || env.SSH_PORT == null)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          envs: WEB_USER,WEB_GROUP
          script: |
            echo "Iniciando despliegue de Backend en el servidor..."
            set -eo pipefail

            # Detect default web user/group if not provided (Arch: http, Debian/Ubuntu: www-data)
            WEB_USER="${WEB_USER:-$(getent passwd http >/dev/null 2>&1 && echo http || echo www-data)}"
            WEB_GROUP="${WEB_GROUP:-$WEB_USER}"

            # Detener servicio (sudo necesario)
            sudo systemctl stop kioscomanager.service || true

            # Crear directorio temporal si no existe
            mkdir -p /tmp/backend_deploy_temp_dir

            # Limpiar el directorio de publicación (ci-cd-deploy tiene permisos)
            sudo rm -rf /var/www/kiosco-manager/publish/*

            # Copiar los archivos desde el directorio temporal
            sudo cp -r /tmp/backend_deploy_temp_dir/publish_backend_temp/. /var/www/kiosco-manager/publish/

            # Limpiar el directorio temporal
            rm -rf /tmp/backend_deploy_temp_dir

            # Ajustar propietario del despliegue
            sudo chown -R "$WEB_USER":"$WEB_GROUP" /var/www/kiosco-manager/publish

            # Iniciar servicio (sudo necesario)
            sudo systemctl start kioscomanager.service

            # Esperar un momento para que arranque
            sleep 5

            # Verificar que el servicio esté activo
            if ! sudo systemctl is-active --quiet kioscomanager.service; then
              echo "Error: El servicio Backend no está activo después del despliegue."
              exit 1
            fi

            sudo systemctl status kioscomanager.service --no-pager
            echo "Despliegue de Backend completado exitosamente."

            # Iniciar servicio (sudo necesario)
            sudo systemctl start kioscomanager.service

            # Esperar un momento para que arranque
            sleep 5

            # Verificar que el servicio esté activo
            if ! sudo systemctl is-active --quiet kioscomanager.service; then
              echo "Error: El servicio Backend no está activo después del despliegue."
              exit 1
            fi

            sudo systemctl status kioscomanager.service --no-pager
            echo "Despliegue de Backend completado exitosamente."


      - name: Transfer Frontend Files to Server (with custom port)
        if: steps.preflight_ssh.outputs.reachable == 'true' && env.SSH_PORT != ''
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "./dist_frontend_temp/"
          target: "/tmp/frontend_deploy_temp_dir"

      - name: Transfer Frontend Files to Server (default port 22)
        if: steps.preflight_ssh.outputs.reachable == 'true' && (env.SSH_PORT == '' || env.SSH_PORT == null)
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          source: "./dist_frontend_temp/"
          target: "/tmp/frontend_deploy_temp_dir"

      - name: Deploy Frontend on Server (custom port)
        if: steps.preflight_ssh.outputs.reachable == 'true' && env.SSH_PORT != ''
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          envs: WEB_USER,WEB_GROUP
          script: |
            echo "Iniciando despliegue de Frontend en el servidor..."
            set -eo pipefail
            
            # Detect default web user/group if not provided
            WEB_USER="${WEB_USER:-$(getent passwd http >/dev/null 2>&1 && echo http || echo www-data)}"
            WEB_GROUP="${WEB_GROUP:-$WEB_USER}"
            
            # Crear el directorio de despliegue si no existe.
            sudo mkdir -p /var/www/kiosco-manager-frontend/browser
            
            # Limpiar y copiar los archivos sin sudo
            sudo rm -rf /var/www/kiosco-manager-frontend/browser/*
            sudo cp -r /tmp/frontend_deploy_temp_dir/dist_frontend_temp/. /var/www/kiosco-manager-frontend/browser/
            
            # Limpiar el directorio temporal
            rm -rf /tmp/frontend_deploy_temp_dir
            
            # Cambiar el propietario del despliegue
            sudo chown -R "$WEB_USER":"$WEB_GROUP" /var/www/kiosco-manager-frontend/browser
      - name: Deploy Frontend on Server (default port 22)
        if: steps.preflight_ssh.outputs.reachable == 'true' && (env.SSH_PORT == '' || env.SSH_PORT == null)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          envs: WEB_USER,WEB_GROUP
          script: |
            echo "Iniciando despliegue de Frontend en el servidor..."
            set -eo pipefail
            
            # Detect default web user/group if not provided
            WEB_USER="${WEB_USER:-$(getent passwd http >/dev/null 2>&1 && echo http || echo www-data)}"
            WEB_GROUP="${WEB_GROUP:-$WEB_USER}"
            
            # Crear el directorio de despliegue si no existe.
            sudo mkdir -p /var/www/kiosco-manager-frontend/browser
            
            # Limpiar y copiar los archivos sin sudo
            sudo rm -rf /var/www/kiosco-manager-frontend/browser/*
            sudo cp -r /tmp/frontend_deploy_temp_dir/dist_frontend_temp/. /var/www/kiosco-manager-frontend/browser/
            
            # Limpiar el directorio temporal
            rm -rf /tmp/frontend_deploy_temp_dir
            
            # Cambiar el propietario del despliegue
            sudo chown -R "$WEB_USER":"$WEB_GROUP" /var/www/kiosco-manager-frontend/browser
            sudo chmod -R 755 /var/www/kiosco-manager-frontend/browser
            sudo find /var/www/kiosco-manager-frontend/browser -type f -exec chmod 644 {} \;
            echo "Contenido final en /var/www/kiosco-manager-frontend/browser:"
            sudo ls -la /var/www/kiosco-manager-frontend/browser | head -n 50
            
            # Reiniciar Nginx con sudo (requerido)
            sudo systemctl restart nginx
            
            sleep 5
            if ! sudo systemctl is-active --quiet nginx; then
              echo "Error: Nginx no está activo después del despliegue."
              exit 1
            fi
            
            sudo nginx -t
            echo "Despliegue de Frontend completado exitosamente."

      - name: "Deploy skipped (host unreachable)"
        if: steps.preflight_ssh.outputs.reachable != 'true'
        run: |
          echo "Skipping deploy: cannot reach ${SSH_HOST}:${SSH_PORT:-22}. This is expected if your Arch PC is offline or SSH is disabled."
          exit 0
